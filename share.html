<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Shared Property</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#f3f6fb;
      color:#0f172a;
    }
    .wrap{max-width:720px;margin:0 auto;min-height:100vh;padding:12px}
    .card{
      background:#fff;
      border-radius:16px;
      padding:10px;
      box-shadow:0 8px 22px rgba(0,0,0,.08);
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .pill{
      padding:6px 10px;border-radius:999px;
      background:#eff6ff;color:#1d4ed8;font-weight:800;font-size:12px
    }
    h1{
      font-size:20px;
      margin:6px 0 10px 0;
      text-transform:capitalize;
      line-height:1.25;
    }
    .meta{
      font-size:15px;
      opacity:.95;
      margin-bottom:6px;
    }
    .sec{margin-top:7px}
    .sec h2{
      font-size:15px;
      margin-bottom:8px;
    }
    #summary{
      font-size:14px;
      line-height:1.55;
      white-space:pre-wrap;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:5px 5px;
    }
    .imgGrid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }
    .imgGrid img{
      width:100%;
      height:92px;
      border-radius:12px;
      object-fit:cover;
      border:1px solid #e5e7eb;
      cursor:pointer;
    }
    .attList{display:flex;flex-direction:column;gap:10px}
    .att{
      display:flex;align-items:center;gap:10px;
      padding:10px;border-radius:14px;border:1px solid #e5e7eb;
      background:#fff;
    }
    .att .name{
      font-weight:800;
      font-size:14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:55vw;
    }
    .att a{
      margin-left:auto;
      background:#1d4ed8;color:#fff;
      padding:9px 12px;border-radius:12px;
      font-size:13px;text-decoration:none;font-weight:900
    }

    /* Fullscreen image viewer */
    .viewer{
      position:fixed; inset:0; z-index:99999;
      background:rgba(0,0,0,.85);
      display:none;
      place-items:center;
      padding:12px;
    }
    .viewer img{
      max-width:100%;
      max-height:88vh;
      border-radius:14px;
      box-shadow:0 18px 55px rgba(0,0,0,.35);
    }
    .viewerClose{
      position:fixed; top:14px; right:14px;
      background:#fff;
      border:0;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
    }

    .empty{
      opacity:.65;
      font-size:13px;
      padding:6px 0;
    }

    .ad-placeholder{
      border: 1px dashed #cbd5e1;
      border-radius: 14px;
      padding: 14px;
      background: #f8fafc;
    }
    .ad-badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      background:#111827;
      color:#fff;
      margin-bottom:8px;
    }
    .ad-title{font-weight:900;font-size:14px;margin-bottom:4px;}
    .ad-desc{opacity:.75;font-size:13px;line-height:1.35;}

    /* ===================================================
       ✅ Loader overlay + hide content initially
       =================================================== */
    #pageLoader{
      position:fixed;
      inset:0;
      z-index:999999;
      background:#f3f6fb;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
    }
    .loaderSpin{
      width:42px;
      height:42px;
      border:4px solid #cbd5e1;
      border-top-color:#1d4ed8;
      border-radius:50%;
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    #pageContent{ display:none; }
  </style>
</head>

<body>

  <!-- ✅ Loader -->
  <div id="pageLoader">
    <div class="loaderSpin"></div>
    <div style="font-weight:900;font-family:system-ui;">Loading property...</div>
    <div style="opacity:.7;font-size:13px;">Please wait</div>
  </div>

  <!-- ✅ Content (hidden until data is ready) -->
  <div id="pageContent">
    <div class="wrap">
      <main class="card">
        <div class="row">
          <div class="pill" id="typePill" style="display:none;"></div>
          <div class="pill" id="catPill" style="display:none;"></div>
        </div>

        <h1 id="title"></h1>

        <div class="meta">
          <div><strong>Area:</strong> <span id="area"></span></div>
		  
		  <div id="sharedByRow" style="display:none;margin-top:7px;">
			  <strong>Shared By:</strong>
			  <span id="sharedBy" style="display:inline-flex;gap:6px;align-items:center;flex-wrap:wrap;"></span>
		  </div>

        </div>

        <section class="sec">
          <h2>Summary:</h2>
          <div id="summary"></div>
        </section>

        <section class="sec" id="imgSec">
          <h2>Images:</h2>
          <div class="imgGrid" id="imgGrid"></div>
          <div class="empty" id="imgEmpty" style="display:none;">No images.</div>
        </section>

        <section class="sec" id="attSec">
          <h2>Files:</h2>
          <div class="attList" id="attList"></div>
          <div class="empty" id="attEmpty" style="display:none;">No files.</div>
        </section>
      </main>

      <!-- ✅ Expired UI (hidden by default) -->
	<section class="sec" id="expiredSec" style="display:none;">
	  <div class="card" style="padding:14px;border-radius:16px;">
		
		<div style="font-weight:900;font-size:16px;margin-bottom:10px;">
		  This shared link is expired.
		</div>

		<!-- ✅ NEW: Title line -->
		<div id="expiredTitle"
			 style="margin-top:6px;font-weight:900;font-size:16px;text-transform:capitalize;">
		</div>

		<div id="expiredHint" style="opacity:.85;font-size:14px;line-height:1.45;margin-top:10px;">
		  To get details about the property you can contact:
		</div>

		<div id="expiredContactRow"
			 style="margin-top:10px;font-weight:900;font-size:15px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
		</div>

	  </div>
	</section>


      <!-- ✅ Ad section BELOW the card (not inside it) -->
      <section class="sec" id="adSec">
        <div class="ad-placeholder">
          <div class="ad-badge">Ad</div>
          <div class="ad-title">Test Banner</div>
          <div class="ad-desc">This is a placeholder for your web ad banner.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Fullscreen image viewer -->
  <div class="viewer" id="viewer">
    <button class="viewerClose" id="viewerClose">✕</button>
    <img id="viewerImg" src="" alt="preview"/>
  </div>


  <!-- Media Player Modal (MP4/MP3 offline via IndexedDB Blob) -->
  <div class="viewer" id="mediaViewer" style="display:none;">
        <div id="mediaViewerBody" style="width:min(100%,720px);">
      <!-- injected -->
    </div>
  </div>

<script>
  function qs(k){ return new URLSearchParams(location.search).get(k); }

	function decodeSlug(s){
	  return String(s || '')
		.replace(/\+/g, ' ')
		.trim();
	}

	// ✅ Convert slug back to readable text
	function unslugText(s){
	  return String(s || '')
		.replace(/-/g, ' ')       // hyphen → space
		.replace(/\s{2,}/g, ' ')  // cleanup multiple spaces
		.trim()
		.toLowerCase()
		.replace(/\b\w/g, c => c.toUpperCase()); // ✅ first letter of each word
	}


	function getUrlContact(){
	  // ✅ read from URL, not cache
	  const t = unslugText(decodeSlug(qs('t'))); // title
	  const n = unslugText(decodeSlug(qs('n'))); // name
	  const p = decodeSlug(qs('p'));             // phone (DO NOT unslug)
	  return { title: t, name: n, phone: p };
	}
	  

  function escapeHtml(s){
    return String(s||'')
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function summaryToBullets(summary) {
    let items = [];

    if (Array.isArray(summary)) {
      items = summary.map(s => String(s));
    } else if (typeof summary === 'string') {
      items = summary.split(/\r?\n/);
    } else if (summary && typeof summary === 'object') {
      items = Object.values(summary).map(v => String(v));
    }

    // cleanup lines
    items = items
      .map(s => String(s || '')
        .replace(/\u00A0/g, ' ')
        .replace(/\t/g, ' ')
        .trim()
      )
      .filter(Boolean)
      // ✅ remove bullet markers if already present
      .map(s => s.replace(/^[\s•\-\*\u2022]+/, '').trim());

    if (!items.length) return '';

    return (
      `<ul style="margin:0; padding-left:20px; list-style-type:disc;">` +
      items.map(line => `<li style="margin:0 0 3px 0;">${escapeHtml(line)}</li>`).join('') +
      `</ul>`
    );
  }

  function safeText(v){ return String(v||'').trim(); }

  function showContent(){
    const ld = document.getElementById('pageLoader');
    const ct = document.getElementById('pageContent');
    if (ld) ld.style.display = "none";
    if (ct) ct.style.display = "block";
  }


  // ===================================================
  // ✅ Best Offline: ask browser for persistent storage (reduces auto-eviction)
  // ===================================================
  async function requestPersistence(){
    try{
      if (navigator.storage && navigator.storage.persist){
        const persisted = await navigator.storage.persist();
        return persisted;
      }
    }catch(e){}
    return false;
  }

  // ===================================================
  // ✅ Best Offline: Pre-cache ALL assets (JSON + images + attachments)
  // This ensures 2nd open onward hits NO Supabase requests.
  // ===================================================
  async function precacheAssets(urls){
    try{
      if (!('serviceWorker' in navigator)) return;

      // wait SW ready
      await navigator.serviceWorker.ready;

      // If SW isn't controlling yet (first install), reload once so it controls.
      if (!navigator.serviceWorker.controller){
        location.reload();
        return;
      }

      navigator.serviceWorker.controller.postMessage({
        type: "PRECACHE_ASSETS",
        urls: urls
      });
    }catch(e){}
  }

  // ===================================================
  // ✅ IndexedDB Media Store: best offline for MP4/MP3
  // ===================================================
  const MEDIA_DB = "propcola_share_media_v1";
  const MEDIA_STORE = "files";

  function normalizeMediaKey(url){
    try{
      const u = new URL(url);
      // keep pathname only (ignore query), consistent key
      return u.origin + u.pathname;
    }catch(e){
      return String(url || '');
    }
  }

  function openMediaDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(MEDIA_DB, 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if (!db.objectStoreNames.contains(MEDIA_STORE)){
          db.createObjectStore(MEDIA_STORE, { keyPath: "key" });
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  async function idbGet(key){
    const db = await openMediaDB();
    return new Promise((resolve)=>{
      const tx = db.transaction(MEDIA_STORE, "readonly");
      const st = tx.objectStore(MEDIA_STORE);
      const req = st.get(key);
      req.onsuccess = ()=> resolve(req.result || null);
      req.onerror = ()=> resolve(null);
    });
  }

  async function idbPut(obj){
    const db = await openMediaDB();
    return new Promise((resolve)=>{
      const tx = db.transaction(MEDIA_STORE, "readwrite");
      const st = tx.objectStore(MEDIA_STORE);
      st.put(obj);
      tx.oncomplete = ()=> resolve(true);
      tx.onerror = ()=> resolve(false);
    });
  }

  async function downloadAndStoreBlob(url){
    const key = normalizeMediaKey(url);
    const existing = await idbGet(key);
    if (existing && existing.blob) return existing;

    const res = await fetch(url);
    if (!res.ok) throw new Error("download failed: " + res.status);

    const blob = await res.blob();
    const obj = {
      key,
      blob,
      type: blob.type || res.headers.get("content-type") || "application/octet-stream",
      size: blob.size || 0,
      cached_at: Date.now()
    };
    await idbPut(obj);
    return obj;
  }

  function guessFileType(url, mime){
    const u = String(url || '').toLowerCase();
    if (mime && mime.startsWith("video/")) return "video";
    if (mime && mime.startsWith("audio/")) return "audio";
    if (u.includes(".mp4")) return "video";
    if (u.includes(".webm")) return "video";
    if (u.includes(".mp3")) return "audio";
    if (u.includes(".wav")) return "audio";
    if (u.includes(".m4a")) return "audio";
    return "file";
  }

  function openMediaModal(htmlContent){
    const mv = document.getElementById("mediaViewer");
    const body = document.getElementById("mediaViewerBody");
    if (!mv || !body) return;
    body.innerHTML = htmlContent;
    mv.style.display = "grid";
    history.pushState({ mediaViewer: true }, "");
  }

  function closeMediaModal(fromPop = false){
    const mv = document.getElementById("mediaViewer");
    const body = document.getElementById("mediaViewerBody");
    if (!mv || !body) return;
    mv.style.display = "none";
    body.innerHTML = "";
    if (!fromPop) history.back();
  }

  function wireMediaViewer(){
    const closeBtn = document.getElementById("mediaViewerClose");
    const mv = document.getElementById("mediaViewer");
    if (closeBtn) closeBtn.addEventListener("click", ()=>closeMediaModal(false));
    if (mv) mv.addEventListener("click", (e)=>{ if (e.target === mv) closeMediaModal(false); });

    window.addEventListener("popstate", (e)=>{
      const mv2 = document.getElementById("mediaViewer");
      if (mv2 && mv2.style.display === "grid"){
        closeMediaModal(true);
      }
    });
  }

  async function openOfflineMedia(url){
    const key = normalizeMediaKey(url);

    // 1) try IDB cache first
    let obj = await idbGet(key);

    // 2) if not cached, download now (online only)
    if (!obj || !obj.blob){
      obj = await downloadAndStoreBlob(url);
    }

    const blobUrl = URL.createObjectURL(obj.blob);
    const kind = guessFileType(url, obj.type);

    if (kind === "video"){
      openMediaModal(`
        <video controls autoplay playsinline
               style="width:100%;max-height:78vh;border-radius:14px;background:#000;"
               src="${blobUrl}"></video>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <a href="${blobUrl}" download style="background:#111827;color:#fff;padding:10px 12px;border-radius:12px;text-decoration:none;font-weight:900;">
            Download
          </a>
          <button id="closeMediaBtn" style="border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">
            Close
          </button>
        </div>
      `);
    } else if (kind === "audio"){
      openMediaModal(`
        <audio controls autoplay style="width:100%;" src="${blobUrl}"></audio>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <a href="${blobUrl}" download style="background:#111827;color:#fff;padding:10px 12px;border-radius:12px;text-decoration:none;font-weight:900;">
            Download
          </a>
          <button id="closeMediaBtn" style="border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">
            Close
          </button>
        </div>
      `);
    } else {
      // fallback open blob in new tab
      window.open(blobUrl, "_blank", "noopener");
      return;
    }

    // wire close button
    setTimeout(()=>{
      const btn = document.getElementById("closeMediaBtn");
      if (btn) btn.onclick = ()=> closeMediaModal(false);
    }, 0);
  }


  // ✅ Register Service Worker (Cache Supabase assets)
  (function registerSW(){
    try{
      if (!('serviceWorker' in navigator)) return;
      navigator.serviceWorker.register('./sw.js', { scope: './' })
        .catch(err => console.warn('SW register failed', err));
    }catch(e){}
  })();

  // ===================================================
  // ✅ Cache shared_by/contact so expired link can show fallback
  // ===================================================
  function cacheShareContact(sid, payload){
    try{
      const obj = {
        shared_by: safeText(payload?.shared_by),
        shared_contact: safeText(payload?.shared_contact),
        cached_at: Date.now()
      };
      localStorage.setItem(`share_contact_${sid}`, JSON.stringify(obj));
    }catch(e){}
  }

  function getCachedShareContact(sid){
    try{
      const raw = localStorage.getItem(`share_contact_${sid}`);
      if (!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }

function showExpiredUI(sid){
  // ✅ hide main property card fully
  const cardBlock = document.querySelector('main.card');
  if (cardBlock) cardBlock.style.display = 'none';

  // ✅ show expired section
  const expiredSec = document.getElementById('expiredSec');
  const expiredTitle = document.getElementById('expiredTitle');
  const expiredContactRow = document.getElementById('expiredContactRow');


  if (expiredSec) expiredSec.style.display = 'block';

  // ✅ Take from URL params (title + name + phone)
  const fromUrl = getUrlContact();
  const title = safeText(fromUrl.title);
  const name = safeText(fromUrl.name);
  const phone = safeText(fromUrl.phone);

  // ✅ Show title
  if (expiredTitle) {
    expiredTitle.textContent = title ? `Title: ${title}` : '';
  }

  // ✅ Show name/phone
	if (expiredContactRow) {
	  if (name || phone) {
		expiredContactRow.innerHTML = `
		  <span>${escapeHtml(name || 'Shared By')}</span>
		  ${phone ? `<span style="opacity:0.7;"> - </span><span style="font-weight:800;">${escapeHtml(phone)}</span>` : ''}
		  ${
			phone
			  ? `<a
				   href="tel:${escapeHtml(String(phone).trim())}"
				   title="Call"
				   style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;"
				 >
				   <i class="fa fa-phone" style="color:green;font-size:18px;"></i>
				 </a>`
			  : ``
		  }
		`;
	  } else {
		expiredContactRow.textContent = 'Contact information not available.';
	  }
	}


  // ✅ show page even in expired mode so Ad remains visible
  showContent();
}



  // ===================================================
  // ✅ Save payload locally so JSON/text renders offline even if fetch fails
  // ===================================================
  function saveSharePayload(sid, payload){
    try{
      localStorage.setItem(`share_payload_${sid}`, JSON.stringify({ payload, t: Date.now() }));
    }catch(e){}
  }

  function loadSharePayload(sid){
    try{
      const raw = localStorage.getItem(`share_payload_${sid}`);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return obj?.payload || null;
    }catch(e){ return null; }
  }

  (function init(){
    const sid = String(qs('sid') || '').trim();

    if (!sid){
      document.body.innerHTML = "<div style='padding:18px;font-weight:900;font-family:system-ui'>Invalid share link.</div>";
      return;
    }

    (async function(){
      try{
        const jsonFile = `share_${encodeURIComponent(sid)}.json`;

        const jsonUrl =
          `https://mxuknvleveqqybhbhwnv.supabase.co/storage/v1/object/public/shares/${encodeURIComponent(jsonFile)}`;

        // ✅ DO NOT use no-store, allow SW + browser caching
        const res = await fetch(jsonUrl);
        if (!res.ok) throw new Error("Share JSON not found");

        const payload = await res.json();

        // ✅ Reduce chance of browser clearing offline cache automatically
        requestPersistence();

        // ✅ Pre-cache JSON + all media/files right away for true offline mode
        // After this completes, next opens should NOT hit Supabase at all.
        const assetUrls = [
          jsonUrl,
          ...(Array.isArray(payload.images) ? payload.images : []),
          ...(Array.isArray(payload.attachments) ? payload.attachments.map(a => a?.src).filter(Boolean) : [])
        ].filter(Boolean);

        precacheAssets(assetUrls);

        // ✅ ALSO store MP4/MP3 as Blob in IndexedDB for 100% offline playback
        (async () => {
          try{
            const mediaUrls = [
              ...(Array.isArray(payload.attachments) ? payload.attachments.map(a => a?.src).filter(Boolean) : [])
            ].filter(u => /\.(mp4|webm|mp3|wav|m4a)(\?|$)/i.test(String(u)));

            // download sequentially to avoid bandwidth spikes
            for (const u of mediaUrls){
              try{ await downloadAndStoreBlob(u); }catch(e){}
            }
          }catch(e){
        // ✅ Offline fallback: render from last cached payload instead of showing expired
        try{
          const cachedPayload = loadSharePayload(sid);
          if (cachedPayload){
            // render using same flow by simulating payload path
            document.getElementById('pageLoader').style.display = "none";
            // reuse existing render logic below by quick inline render (minimal)
            // Note: we call init again style block already exists; simplest is reload with cached content:
            // We'll set a flag and render basic fields.
            const payload = cachedPayload;

            // Pills + render UI
            document.getElementById('title').textContent = safeText(payload.title);
            document.getElementById('area').textContent  = safeText(payload.area);
            document.getElementById('summary').innerHTML = summaryToBullets(payload.summary);

            const type = safeText(payload.type);
            const cat  = safeText(payload.category);
            const typePill = document.getElementById('typePill');
            const catPill  = document.getElementById('catPill');
            if (type) { typePill.textContent = type; typePill.style.display = "inline-flex"; }
            if (cat)  { catPill.textContent  = cat;  catPill.style.display  = "inline-flex"; }

            const imgs = Array.isArray(payload.images) ? payload.images : [];
            const imgSec  = document.getElementById('imgSec');
            const imgGrid = document.getElementById('imgGrid');
            if (!imgs.length){
              if (imgSec) imgSec.style.display = "none";
            } else {
              if (imgSec) imgSec.style.display = "block";
              imgGrid.innerHTML = imgs.map(src => `<img src="${escapeHtml(src)}" data-src="${escapeHtml(src)}" alt="image">`).join('');
            }

            const atts = Array.isArray(payload.attachments) ? payload.attachments : [];
            const attSec  = document.getElementById('attSec');
            const attList = document.getElementById('attList');
            if (!atts.length){
              if (attSec) attSec.style.display = "none";
            } else {
              if (attSec) attSec.style.display = "block";
              attList.innerHTML = atts.map((a, idx) => {
                const name = escapeHtml(a?.name || ("Attachment " + (idx+1)));
                const src  = escapeHtml(a?.src || "");
                return `
                  <div class="att">
                    <div class="name">${name}</div>
                    ${
                      (/\.(mp4|webm|mp3|wav|m4a)(\?|$)/i.test(src))
                        ? `<button class="openMediaBtn" data-src="${src}"
                             style="margin-left:auto;background:#1d4ed8;color:#fff;padding:9px 12px;border-radius:12px;
                                    font-size:13px;border:0;font-weight:900;cursor:pointer;">Play</button>`
                        : `<a href="${src}" target="_blank" rel="noopener">Open</a>`
                    }
                  </div>
                `;
              }).join('');
            }

            // Wire media buttons
            wireMediaViewer();
            attList.addEventListener('click', (ev) => {
              const btn = ev.target && ev.target.closest ? ev.target.closest(".openMediaBtn") : null;
              if (!btn) return;
              const src = btn.getAttribute("data-src");
              if (src) openOfflineMedia(src).catch(()=>alert("Media not cached yet."));
            });

            // Fullscreen viewer already wired in original code (may not run here), but ok
            showContent();
            return;
          }
        }catch(_){}
}
        })();


        if (!payload) throw new Error("Invalid JSON payload");

        // ✅ Cache payload + shared_by/contact for full offline fallback
        saveSharePayload(sid, payload);
        cacheShareContact(sid, payload);

        // ✅ Render UI
        document.getElementById('title').textContent = safeText(payload.title);
        document.getElementById('area').textContent  = safeText(payload.area);
        document.getElementById('summary').innerHTML = summaryToBullets(payload.summary);

		// Shared By
		const sb = safeText(payload.shared_by);
		const sc = safeText(payload.shared_contact);
		const sharedByRow = document.getElementById('sharedByRow');
		const sharedBy = document.getElementById('sharedBy');

		if ((sb || sc) && sharedByRow && sharedBy) {
		  sharedByRow.style.display = "block";

		  // ✅ Reuse Favorites logic: show phone icon only if contact exists
		  sharedBy.innerHTML = `
			<span style="font-weight:500;">${escapeHtml(sb || 'N/A')}</span>
			${sc ? `<span style="opacity:0.7;"> - </span><span>${escapeHtml(sc)}</span>` : ''}
			${
			  sc
				? `<a
					 href="tel:${escapeHtml(String(sc).trim())}"
					 title="Call Publisher"
					 style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;
							margin-left:10px;"
				   >
					 <i class="fa fa-phone" style="color:green;font-size:18px;"></i>
				   </a>`
				: ``
			}
		  `;
		}


        // Pills
        const type = safeText(payload.type);
        const cat  = safeText(payload.category);

        const typePill = document.getElementById('typePill');
        const catPill  = document.getElementById('catPill');

        if (type) { typePill.textContent = type; typePill.style.display = "inline-flex"; }
        if (cat)  { catPill.textContent  = cat;  catPill.style.display  = "inline-flex"; }

        // Images
        const imgs = Array.isArray(payload.images) ? payload.images : [];
        const imgSec  = document.getElementById('imgSec');
        const imgGrid = document.getElementById('imgGrid');

        if (!imgs.length){
          if (imgSec) imgSec.style.display = "none";
        } else {
          if (imgSec) imgSec.style.display = "block";
          imgGrid.innerHTML = imgs.map(src =>
            `<img src="${escapeHtml(src)}" data-src="${escapeHtml(src)}" alt="image">`
          ).join('');
        }

        // Attachments
        const atts = Array.isArray(payload.attachments) ? payload.attachments : [];
        const attSec  = document.getElementById('attSec');
        const attList = document.getElementById('attList');

        if (!atts.length){
          if (attSec) attSec.style.display = "none";
        } else {
          if (attSec) attSec.style.display = "block";
          attList.innerHTML = atts.map((a, idx) => {
            const name = escapeHtml(a?.name || ("Attachment " + (idx+1)));
            const src  = escapeHtml(a?.src || "");
            return `
              <div class="att">
                <div class="name">${name}</div>
                ${
                  (/\.(mp4|webm|mp3|wav|m4a)(\?|$)/i.test(src))
                    ? `<button class="openMediaBtn" data-src="${src}"
                         style="margin-left:auto;background:#1d4ed8;color:#fff;padding:9px 12px;border-radius:12px;
                                font-size:13px;border:0;font-weight:900;cursor:pointer;">Play</button>`
                    : `<a href="${src}" target="_blank" rel="noopener">Open</a>`
                }
              </div>
            `;
          }).join('');
        }

        // ✅ Wire offline media buttons (MP4/MP3)
        wireMediaViewer();
        attList.addEventListener('click', (e) => {
          const btn = e.target && e.target.closest ? e.target.closest(".openMediaBtn") : null;
          if (!btn) return;
          const src = btn.getAttribute("data-src");
          if (!src) return;

          // open from IndexedDB blob (offline-safe)
          openOfflineMedia(src).catch(() => {
            alert("This media is not cached yet. Please open once with internet.");
          });
        });

        // Fullscreen image viewer
        const viewer = document.getElementById('viewer');
        const viewerImg = document.getElementById('viewerImg');
        const viewerClose = document.getElementById('viewerClose');

        let viewerOpen = false;

        imgGrid.addEventListener('click', (e) => {
          const t = e.target;
          if (!t || t.tagName !== "IMG") return;

          const src = t.getAttribute("data-src") || t.getAttribute("src");
          if (!src) return;

          viewerImg.src = src;
          viewer.style.display = "grid";

          // ✅ Push a history entry so Back button closes viewer first
          if (!viewerOpen) {
            viewerOpen = true;
            history.pushState({ viewer: true }, "");
          }
        });

        function closeViewer(fromPopstate = false){
          viewer.style.display = "none";
          viewerImg.src = "";

          // ✅ If user closed by ✕ button, remove viewer history state
          if (viewerOpen && !fromPopstate) {
            viewerOpen = false;
            history.back();
          } else {
            viewerOpen = false;
          }
        }

        window.addEventListener('popstate', (event) => {
          if (viewerOpen) {
            // ✅ Back button should close viewer, not exit page
            closeViewer(true);
          }
        });

        viewerClose.addEventListener('click', closeViewer);
        viewer.addEventListener('click', (e) => {
          if (e.target === viewer) closeViewer();
        });

        // ✅ Show page only AFTER everything is ready
        showContent();

      }catch(e){
        const ld = document.getElementById('pageLoader');
        if (ld) ld.style.display = "none";

        // ✅ show expired UI (keeps Ad section visible)
        showExpiredUI(sid);
      }
    })();
  })();
</script>

</body>
</html>
