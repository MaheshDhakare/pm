<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Shared Property</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#f3f6fb;
      color:#0f172a;
    }
    .wrap{max-width:720px;margin:0 auto;min-height:100vh;padding:12px}
    .card{
      background:#fff;
      border-radius:16px;
      padding:10px;
      box-shadow:0 8px 22px rgba(0,0,0,.08);
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .pill{
      padding:6px 10px;border-radius:999px;
      background:#eff6ff;color:#1d4ed8;font-weight:800;font-size:12px
    }
    h1{
      font-size:20px;
      margin:6px 0 10px 0;
      text-transform:capitalize;
      line-height:1.25;
    }
    .meta{
      font-size:15px;
      opacity:.95;
      margin-bottom:6px;
    }
    .sec{margin-top:7px}
    .sec h2{
      font-size:15px;
      margin-bottom:8px;
    }
    #summary{
      font-size:14px;
      line-height:1.55;
      white-space:pre-wrap;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:5px 5px;
    }
    .imgGrid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }
    .imgGrid img{
      width:100%;
      height:92px;
      border-radius:12px;
      object-fit:cover;
      border:1px solid #e5e7eb;
      cursor:pointer;
      background:#e5e7eb;
    }
    .attList{display:flex;flex-direction:column;gap:10px}
    .att{
      display:flex;align-items:center;gap:10px;
      padding:10px;border-radius:14px;border:1px solid #e5e7eb;
      background:#fff;
    }
    .att .name{
      font-weight:800;
      font-size:14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:55vw;
    }
    .att a{
      margin-left:auto;
      background:#1d4ed8;color:#fff;
      padding:9px 12px;border-radius:12px;
      font-size:13px;text-decoration:none;font-weight:900
    }

    /* Fullscreen image viewer */
    .viewer{
      position:fixed; inset:0; z-index:99999;
      background:rgba(0,0,0,.85);
      display:none;
      place-items:center;
      padding:12px;
    }
    .viewer img{
      max-width:100%;
      max-height:88vh;
      border-radius:14px;
      box-shadow:0 18px 55px rgba(0,0,0,.35);
    }
    .viewerClose{
      position:fixed; top:14px; right:14px;
      background:#fff;
      border:0;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
    }

    .empty{
      opacity:.65;
      font-size:13px;
      padding:6px 0;
    }

    .ad-placeholder{
      border: 1px dashed #cbd5e1;
      border-radius: 14px;
      padding: 8px;
      background: #f8fafc;
    }
    .ad-badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      background:#111827;
      color:#fff;
      margin-bottom:8px;
    }
    .ad-title{font-weight:900;font-size:14px;margin-bottom:4px;}
    .ad-desc{opacity:.75;font-size:13px;line-height:1.35;}

    /* Loader overlay + hide content initially */
    #pageLoader{
      position:fixed;
      inset:0;
      z-index:999999;
      background:#f3f6fb;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
    }
    .loaderSpin{
      width:42px;
      height:42px;
      border:4px solid #cbd5e1;
      border-top-color:#1d4ed8;
      border-radius:50%;
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    #pageContent{ display:none; }

	#pageContent {
	  padding-bottom: 70px;
	}

	/* Fixed bar that hugs the safe bottom and stays on screen */
	#stickyBanner{
	  position: fixed;
	  left: 0; right: 0;
	  bottom: 0;
	  height: calc(var(--ad-height) + env(safe-area-inset-bottom));
	  padding-bottom: env(safe-area-inset-bottom);   /* clears iOS gesture area */
	  background: #ffffff;
	  border-top: 1px solid #e6eef6;
	  box-shadow: 0 -4px 12px rgba(2,6,23,0.06);
	  z-index: 1200; /* below your modal-backdrop (9999), above content */
	}

	/* Center inside your site width so it aligns with the app grid */
	#stickyBanner .sticky-inner{
	  max-width: 1200px;
	  margin: 0 auto;
	  height: var(--ad-height);
	  display: flex;
	  align-items: center;
	  justify-content: center;
	}

  </style>
</head>

<body>

  <!-- Loader -->
  <div id="pageLoader">
    <div class="loaderSpin"></div>
	<div id="loaderTitle" style="font-weight:900;font-family:system-ui;">Loading property...</div>
	<!-- <div id="loaderSub" style="opacity:.7;font-size:13px;">Please wait</div> -->
	
  </div>

  <!-- Content -->
  <div id="pageContent">
    <div class="wrap">
      <main class="card">
        <div class="row">
          <div class="pill" id="typePill" style="display:none;"></div>
          <div class="pill" id="catPill" style="display:none;"></div>
        </div>

        <h1 id="title"></h1>

        <div class="meta">
          <div><strong>Area:</strong> <span id="area"></span></div>

          <div id="sharedByRow" style="display:none;margin-top:7px;">
            <strong>Shared By:</strong>
            <span id="sharedBy" style="display:inline-flex;gap:6px;align-items:center;flex-wrap:wrap;"></span>
          </div>
        </div>

        <section class="sec">
          <h2>Summary:</h2>
          <div id="summary"></div>
        </section>

		<section class="sec" id="locationSec" style="display:none;">
		  <h2>Location:</h2>
		  <div id="location"
			   style="
				 font-size:14px;
				 background:#f8fafc;
				 border:1px solid #e5e7eb;
				 border-radius:10px;
				 padding:8px 10px;
			   ">
		  </div>
		</section>

        <section class="sec" id="imgSec">
          <h2>Images:</h2>
          <div class="imgGrid" id="imgGrid"></div>
          <div class="empty" id="imgEmpty" style="display:none;">No images.</div>
        </section>

        <section class="sec" id="attSec">
          <h2>Files:</h2>
          <div class="attList" id="attList"></div>
          <div class="empty" id="attEmpty" style="display:none;">No files.</div>
        </section>
      </main>

      <!-- Expired UI -->
      <section class="sec" id="expiredSec" style="display:none;">
        <div class="card" style="padding:14px;border-radius:16px;">
          <div style="font-weight:900;font-size:16px;margin-bottom:10px;">
            This shared link is expired.
          </div>

          <div id="expiredTitle"
               style="margin-top:6px;font-weight:900;font-size:16px;text-transform:capitalize;">
          </div>

          <div id="expiredHint" style="opacity:.85;font-size:14px;line-height:1.45;margin-top:10px;">
            To get details about the property you can contact:
          </div>

          <div id="expiredContactRow"
               style="margin-top:10px;font-weight:900;font-size:15px;display:flex;align-items:center;gap:10px;flex-wrap:wrap;">
          </div>
        </div>
      </section>


<!-- 		<section class="sec" id="adSec">
		  <div class="ad-placeholder">
			<div class="ad-badge">Ad</div>
			<div id="container-358ccab821f56114a2734139c41efd06"></div>
		  </div>
		</section> -->

    </div>
  </div>

  <!-- Fullscreen image viewer -->
  <div class="viewer" id="viewer">
    <button class="viewerClose" id="viewerClose">‚úï</button>
    <img id="viewerImg" src="" alt="preview"/>
  </div>

  <!-- Media Player Modal -->
  <div class="viewer" id="mediaViewer" style="display:none;">
    <div id="mediaViewerBody" style="width:min(100%,720px);">
      <!-- injected -->
    </div>
  </div>


<script>
  function qs(k){ return new URLSearchParams(location.search).get(k); }

  function decodeSlug(s){
    return String(s || '').replace(/\+/g, ' ').trim();
  }

  function unslugText(s){
    return String(s || '')
      .replace(/-/g, ' ')
      .replace(/\s{2,}/g, ' ')
      .trim()
      .toLowerCase()
      .replace(/\b\w/g, c => c.toUpperCase());
  }

  function getUrlContact(){
    const t = unslugText(decodeSlug(qs('t')));
    const n = unslugText(decodeSlug(qs('n')));
    const p = decodeSlug(qs('p'));
    return { title: t, name: n, phone: p };
  }

  function escapeHtml(s){
    return String(s||'')
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function summaryToBullets(summary) {
    let items = [];
    if (Array.isArray(summary)) items = summary.map(s => String(s));
    else if (typeof summary === 'string') items = summary.split(/\r?\n/);
    else if (summary && typeof summary === 'object') items = Object.values(summary).map(v => String(v));

    items = items
      .map(s => String(s || '').replace(/\u00A0/g, ' ').replace(/\t/g, ' ').trim())
      .filter(Boolean)
      .map(s => s.replace(/^[\s‚Ä¢\-\*\u2022]+/, '').trim());

    if (!items.length) return '';
    return (
      `<ul style="margin:0; padding-left:20px; list-style-type:disc;">` +
      items.map(line => `<li style="margin:0 0 3px 0;">${escapeHtml(line)}</li>`).join('') +
      `</ul>`
    );
  }

  function safeText(v){ return String(v||'').trim(); }

  function showContent(){
    const ld = document.getElementById('pageLoader');
    const ct = document.getElementById('pageContent');
    if (ld) ld.style.display = "none";
    if (ct) ct.style.display = "block";
  }

  // Ask browser for persistent storage
  async function requestPersistence(){
    try{
      if (navigator.storage && navigator.storage.persist){
        return await navigator.storage.persist();
      }
    }catch(e){}
    return false;
  }

  // IndexedDB store (ALL files)
  const MEDIA_DB = "propcola_share_media_v1";
  const MEDIA_STORE = "files";

  function normalizeMediaKey(url){
    try{
      const u = new URL(url);
      return u.origin + u.pathname;
    }catch(e){
      return String(url || '');
    }
  }

  function openMediaDB(){
    return new Promise((resolve, reject)=>{
      const req = indexedDB.open(MEDIA_DB, 1);
      req.onupgradeneeded = ()=>{
        const db = req.result;
        if (!db.objectStoreNames.contains(MEDIA_STORE)){
          db.createObjectStore(MEDIA_STORE, { keyPath: "key" });
        }
      };
      req.onsuccess = ()=> resolve(req.result);
      req.onerror = ()=> reject(req.error);
    });
  }

  async function idbGet(key){
    const db = await openMediaDB();
    return new Promise((resolve)=>{
      const tx = db.transaction(MEDIA_STORE, "readonly");
      const st = tx.objectStore(MEDIA_STORE);
      const req = st.get(key);
      req.onsuccess = ()=> resolve(req.result || null);
      req.onerror = ()=> resolve(null);
    });
  }

  async function idbPut(obj){
    const db = await openMediaDB();
    return new Promise((resolve)=>{
      const tx = db.transaction(MEDIA_STORE, "readwrite");
      const st = tx.objectStore(MEDIA_STORE);
      st.put(obj);
      tx.oncomplete = ()=> resolve(true);
      tx.onerror = ()=> resolve(false);
    });
  }

  async function downloadAndStoreBlob(url){
    const key = normalizeMediaKey(url);
    const existing = await idbGet(key);
    if (existing && existing.blob) return existing;

    const res = await fetch(url);
    if (!res.ok) throw new Error("download failed: " + res.status);

    const blob = await res.blob();
    const obj = {
      key,
      blob,
      type: blob.type || res.headers.get("content-type") || "application/octet-stream",
      size: blob.size || 0,
      cached_at: Date.now()
    };
    await idbPut(obj);
    return obj;
  }

  function guessExtType(url, mime){
    const u = String(url || '').toLowerCase();
    if (mime && mime.startsWith("image/")) return "image";

    if (/\.(png|jpg|jpeg|webp|gif)(\?|$)/i.test(u)) return "image";
    if (/\.(pdf)(\?|$)/i.test(u)) return "pdf";
    if (/\.(mp4|webm)(\?|$)/i.test(u)) return "video";
    if (/\.(mp3|wav|m4a)(\?|$)/i.test(u)) return "audio";
    return "file";
  }

  async function getOrDownloadBlobUrl(src){
    const key = normalizeMediaKey(src);
    let obj = await idbGet(key);
    if (!obj || !obj.blob){
      obj = await downloadAndStoreBlob(src);
    }
    return { blobUrl: URL.createObjectURL(obj.blob), mime: obj.type || "" };
  }

  // =========================================
  // Modals: Media Viewer
  // =========================================
  let mediaViewerOpen = false;

  function openMediaModal(htmlContent){
    const mv = document.getElementById("mediaViewer");
    const body = document.getElementById("mediaViewerBody");
    if (!mv || !body) return;

    body.innerHTML = htmlContent;
    mv.style.display = "grid";

    if (!mediaViewerOpen){
      mediaViewerOpen = true;
      history.pushState({ mediaViewer: true }, "");
    }
  }

  function closeMediaModal(fromPopstate = false){
    const mv = document.getElementById("mediaViewer");
    const body = document.getElementById("mediaViewerBody");
    if (!mv || !body) return;

    mv.style.display = "none";
    body.innerHTML = "";

    if (mediaViewerOpen && !fromPopstate) {
      mediaViewerOpen = false;
      history.back();
    } else {
      mediaViewerOpen = false;
    }
  }

  function wireMediaViewer(){
    const mv = document.getElementById("mediaViewer");

    if (mv) mv.addEventListener("click", (e)=>{
      if (e.target === mv) closeMediaModal(false);
    });

    window.addEventListener("popstate", ()=>{
      if (mediaViewerOpen){
        closeMediaModal(true);
      }
    });
  }

  async function openOfflineMedia(url){
    const { blobUrl, mime } = await getOrDownloadBlobUrl(url);
    const kind = guessExtType(url, mime);

    if (kind === "video"){
      openMediaModal(`
        <video controls autoplay playsinline
               style="width:100%;max-height:95dvh;border-radius:14px;background:#000;"
               src="${blobUrl}"></video>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button id="closeMediaBtn"
                  style="border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">
            Close
          </button>
        </div>
      `);
    } else if (kind === "audio"){
      openMediaModal(`
        <audio controls autoplay style="width:100%;" src="${blobUrl}"></audio>
        <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap;">
          <button id="closeMediaBtn"
                  style="border:0;border-radius:12px;padding:10px 12px;font-weight:900;cursor:pointer;">
            Close
          </button>
        </div>
      `);
    } else {
      window.open(blobUrl, "_blank", "noopener");
      return;
    }

    setTimeout(()=>{
      const btn = document.getElementById("closeMediaBtn");
      if (btn) btn.onclick = ()=> closeMediaModal(false);
    }, 0);
  }

  // Register Service Worker (optional but fine)
  (function registerSW(){
    try{
      if (!('serviceWorker' in navigator)) return;
      navigator.serviceWorker.register('./sw.js', { scope: './' })
        .catch(()=>{});
    }catch(e){}
  })();

  // Cache share contact
  function cacheShareContact(sid, payload){
    try{
      localStorage.setItem(`share_contact_${sid}`, JSON.stringify({
        shared_by: safeText(payload?.shared_by),
        shared_contact: safeText(payload?.shared_contact),
        cached_at: Date.now()
      }));
    }catch(e){}
  }

  // Expired UI
  function showExpiredUI(sid){
    const cardBlock = document.querySelector('main.card');
    if (cardBlock) cardBlock.style.display = 'none';

    const expiredSec = document.getElementById('expiredSec');
    const expiredTitle = document.getElementById('expiredTitle');
    const expiredContactRow = document.getElementById('expiredContactRow');
    if (expiredSec) expiredSec.style.display = 'block';

    const fromUrl = getUrlContact();
    const title = safeText(fromUrl.title);
    const name = safeText(fromUrl.name);
    const phone = safeText(fromUrl.phone);

    if (expiredTitle) expiredTitle.textContent = title ? `Title: ${title}` : '';

    if (expiredContactRow) {
      if (name || phone) {
        expiredContactRow.innerHTML = `
          <span>${escapeHtml(name || 'Shared By')}</span>
          ${phone ? `<span style="opacity:0.7;"> - </span><span style="font-weight:800;">${escapeHtml(phone)}</span>` : ''}
          ${
			phone
			  ? `
				<!-- üìû CALL -->
				<a href="tel:${escapeHtml(String(phone).trim())}"
				   title="Call"
				   style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;">
				  <i class="fa fa-phone" style="color:green;font-size:18px;"></i>
				</a>

				<!-- üü¢ WHATSAPP -->
				<a href="https://wa.me/${escapeHtml(String(phone).trim().replace(/[^\d]/g,''))}"
				   target="_blank"
				   title="WhatsApp"
				   style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;margin-left:12px;">
				  <i class="fa-brands fa-whatsapp"
					 style="color:#25D366;font-size:18px;"></i>
				</a>
			  `
			  : ``

          }
        `;
      } else {
        expiredContactRow.textContent = 'Contact information not available.';
      }
    }

    showContent();
  }

  // JSON payload cache
  function saveSharePayload(sid, payload){
    try{
      localStorage.setItem(`share_payload_${sid}`, JSON.stringify({ payload, t: Date.now() }));
    }catch(e){}
  }
  function loadSharePayload(sid){
    try{
      const raw = localStorage.getItem(`share_payload_${sid}`);
      if (!raw) return null;
      const obj = JSON.parse(raw);
      return obj?.payload || null;
    }catch(e){ return null; }
  }

  // =========================================
  // Render Function (Reusable)
  // =========================================
  async function renderFromPayload(payload){
    document.getElementById('title').textContent = safeText(payload.title);
    document.getElementById('area').textContent  = safeText(payload.area);
    document.getElementById('summary').innerHTML = summaryToBullets(payload.summary);
	
	// ===== Location =====
	(function renderLocation(){
	  const locSec = document.getElementById('locationSec');
	  const locBox = document.getElementById('location');
	  if (!locSec || !locBox) return;

	  const mapUrl = safeText(payload.location);

	  if (!mapUrl) {
		locSec.style.display = "none";
		return;
	  }

	locBox.innerHTML = `
	  <a href="${escapeHtml(mapUrl)}"
		 target="_blank"
		 rel="noopener noreferrer"
		 style="
		   color:#2563eb;
		   font-weight:700;
		   text-decoration:underline;
		   display:inline-flex;
		   align-items:center;
		   gap:6px;
		 ">
		<i class="fa fa-map-marker-alt"></i>
		Click to view location on map
	  </a>
	`;

	  locSec.style.display = "block";
	})();



    // Shared By
    const sb = safeText(payload.shared_by);
    const sc = safeText(payload.shared_contact);
    const sharedByRow = document.getElementById('sharedByRow');
    const sharedBy = document.getElementById('sharedBy');

    if ((sb || sc) && sharedByRow && sharedBy) {
      sharedByRow.style.display = "block";
		sharedBy.innerHTML = `
		  <span style="font-weight:500;">${escapeHtml(sb || 'N/A')}</span>
		  ${sc ? `<span style="opacity:0.7;"> - </span><span>${escapeHtml(sc)}</span>` : ''}

		  ${
			sc
			  ? `
				<!-- üìû CALL -->
				<a href="tel:${escapeHtml(String(sc).trim())}"
				   title="Call Publisher"
				   style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;margin-left:10px;">
				  <i class="fa fa-phone" style="color:green;font-size:18px;"></i>
				</a>

				<!-- üü¢ WHATSAPP -->
				<a href="https://wa.me/${escapeHtml(String(sc).trim().replace(/[^\d]/g,''))}"
				   target="_blank"
				   title="WhatsApp Publisher"
				   style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;margin-left:12px;">
				  <i class="fa-brands fa-whatsapp"
					 style="color:#25D366;font-size:18px;"></i>
				</a>
			  `
			  : ``
		  }
		`;

    }

    // Pills
    const type = safeText(payload.type);
    const cat  = safeText(payload.category);
    const typePill = document.getElementById('typePill');
    const catPill  = document.getElementById('catPill');
    if (type) { typePill.textContent = type; typePill.style.display = "inline-flex"; }
    if (cat)  { catPill.textContent  = cat;  catPill.style.display  = "inline-flex"; }

    // Images (render placeholders first, then swap to blob URLs)
    const imgs = Array.isArray(payload.images) ? payload.images : [];
    const imgSec  = document.getElementById('imgSec');
    const imgGrid = document.getElementById('imgGrid');

    if (!imgs.length){
      if (imgSec) imgSec.style.display = "none";
    } else {
      if (imgSec) imgSec.style.display = "block";
      imgGrid.innerHTML = imgs.map((src, i) =>
        `<img src="" data-src="${escapeHtml(src)}" data-i="${i}" alt="image">`
      ).join('');

      // Load blob URLs (no Supabase URL shown)
		const list = imgGrid.querySelectorAll("img[data-src]");
		for (const im of list){
		  const src = im.getAttribute("data-src");
		  if (!src) continue;

		  try{
			const key = normalizeMediaKey(src);
			const obj = await idbGet(key);
			if (obj && obj.blob){
			  const blobUrl = URL.createObjectURL(obj.blob);
			  im.src = blobUrl;
			  im.setAttribute("data-blob", blobUrl);
			}
		  }catch(e){}
		}

    }

    // Attachments
    const atts = Array.isArray(payload.attachments) ? payload.attachments : [];
    const attSec  = document.getElementById('attSec');
    const attList = document.getElementById('attList');

    if (!atts.length){
      if (attSec) attSec.style.display = "none";
    } else {
      if (attSec) attSec.style.display = "block";
      attList.innerHTML = atts.map((a, idx) => {
        const name = escapeHtml(a?.name || ("Attachment " + (idx+1)));
        const src  = escapeHtml(a?.src || "");
        const isMedia = (/\.(mp4|webm|mp3|wav|m4a)(\?|$)/i.test(src));
        return `
          <div class="att">
            <div class="name">${name}</div>
            ${
              isMedia
                ? `<button class="openMediaBtn" data-src="${src}"
                    style="margin-left:auto;background:#1d4ed8;color:#fff;padding:9px 12px;border-radius:12px;
                           font-size:13px;border:0;font-weight:900;cursor:pointer;">Play</button>`
                : `<button class="openFileBtn" data-src="${src}"
                    style="margin-left:auto;background:#1d4ed8;color:#fff;padding:9px 12px;border-radius:12px;
                           font-size:13px;border:0;font-weight:900;cursor:pointer;">Open</button>`
            }
          </div>
        `;
      }).join('');
    }

    // Wire media buttons
    wireMediaViewer();

    if (attList){
      attList.addEventListener('click', (e) => {
        const mediaBtn = e.target && e.target.closest ? e.target.closest(".openMediaBtn") : null;
        if (mediaBtn){
          const src = mediaBtn.getAttribute("data-src");
          if (!src) return;
          openOfflineMedia(src).catch(()=>alert("This media is not cached yet. Please open once with internet."));
          return;
        }
      });

      // File buttons (PDF included)
      attList.addEventListener("click", async (e)=>{
        const fileBtn = e.target && e.target.closest ? e.target.closest(".openFileBtn") : null;
        if (!fileBtn) return;
        const src = fileBtn.getAttribute("data-src");
        if (!src) return;

        try{
          const { blobUrl, mime } = await getOrDownloadBlobUrl(src);

          window.open(blobUrl, "_blank", "noopener");
        }catch(err){
          alert("File not cached yet. Please open once with internet.");
        }
      });
    }

    // Fullscreen image viewer
    const viewer = document.getElementById('viewer');
    const viewerImg = document.getElementById('viewerImg');
    const viewerClose = document.getElementById('viewerClose');
    let viewerOpen = false;

    imgGrid.addEventListener('click', (e) => {
      const t = e.target;
      if (!t || t.tagName !== "IMG") return;
      const src = t.getAttribute("data-blob") || t.getAttribute("src") || t.getAttribute("data-src");
      if (!src) return;

      viewerImg.src = src;
      viewer.style.display = "grid";

      if (!viewerOpen) {
        viewerOpen = true;
        history.pushState({ viewer: true }, "");
      }
    });

    function closeViewer(fromPopstate = false){
      viewer.style.display = "none";
      viewerImg.src = "";
      if (viewerOpen && !fromPopstate) {
        viewerOpen = false;
        history.back();
      } else {
        viewerOpen = false;
      }
    }

    window.addEventListener('popstate', () => {
      if (viewerOpen) closeViewer(true);
    });

    viewerClose.addEventListener('click', closeViewer);
    viewer.addEventListener('click', (e) => {
      if (e.target === viewer) closeViewer();
    });
  }

  // =========================================
  // Main init
  // =========================================
  (function init(){
    const sid = String(qs('sid') || '').trim();

    if (!sid){
      document.body.innerHTML = "<div style='padding:18px;font-weight:900;font-family:system-ui'>Invalid share link.</div>";
      return;
    }

(async function(){
  try{

    let payload;

    // 1Ô∏è‚É£ Try cache first
    const cachedPayload = loadSharePayload(sid);

    if (cachedPayload) {
      payload = cachedPayload;
    } else {
      // 2Ô∏è‚É£ Fetch from network
      const jsonFile = `share_${encodeURIComponent(sid)}.json`;
      const jsonUrl = `https://mxuknvleveqqybhbhwnv.supabase.co/storage/v1/object/public/shares/${encodeURIComponent(jsonFile)}`;

      const res = await fetch(jsonUrl);
      if (!res.ok) throw new Error("Share JSON not found");

      payload = await res.json();

      requestPersistence();

      saveSharePayload(sid, payload);
      cacheShareContact(sid, payload);
    }

    // 3Ô∏è‚É£ Cache ALL media before rendering
    const urls = [
      ...(Array.isArray(payload.images) ? payload.images : []),
      ...(Array.isArray(payload.attachments)
          ? payload.attachments.map(a => a?.src).filter(Boolean)
          : [])
    ].filter(Boolean);

    const filtered = urls.filter(u =>
      /\.(mp4|webm|mp3|wav|m4a|pdf|png|jpg|jpeg|webp|gif)(\?|$)/i.test(String(u))
    );

    if (filtered.length > 0) {
      let total = filtered.length;
      let done = 0;

      const loaderTitle = document.getElementById('loaderTitle');
      <!-- const loaderSub   = document.getElementById('loaderSub'); -->

      await Promise.all(
        filtered.map(async (u) => {
          try { await downloadAndStoreBlob(u); } catch(e){}

          done++;
          const percent = Math.round((done / total) * 100);

          if (loaderTitle) loaderTitle.textContent = `Loading details... ${percent}%`;
          <!-- if (loaderSub) loaderSub.textContent = `Downloading media ${done} of ${total}`; -->
        })
      );
    }

    // 4Ô∏è‚É£ Now render
    await renderFromPayload(payload);
    showContent();

  } catch(e){

    const cachedPayload = loadSharePayload(sid);
    if (cachedPayload){
      await renderFromPayload(cachedPayload);
      showContent();
      return;
    }

    showExpiredUI(sid);
  }
})();

  })();
</script>


<!-- <script src="https://pl28554800.effectivegatecpm.com/73/be/3e/73be3eb72d2980e3df8cdd18939e0602.js"></script> -->
<!-- <script async data-cfasync="false" src="https://pl28554907.effectivegatecpm.com/358ccab821f56114a2734139c41efd06/invoke.js"></script> -->

<!-- <!-- Sticky Bottom Banner -->
<!-- <div id="stickyBanner"> -->
  <!-- <div class="sticky-inner"> -->

    <!-- <!-- Adsterra / Banner Ad -->
    <!-- <script> -->
      <!-- atOptions = { -->
        <!-- 'key' : '5942674854ad5bb01e53005580dd351b', -->
        <!-- 'format' : 'iframe', -->
        <!-- 'height' : 50, -->
        <!-- 'width' : 320, -->
        <!-- 'params' : {} -->
      <!-- }; -->
    <!-- </script> -->
    <!-- <script src="https://www.highperformanceformat.com/5942674854ad5bb01e53005580dd351b/invoke.js"></script> -->

  <!-- </div> -->
<!-- </div> -->



</body>
</html>
