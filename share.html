<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Shared Property</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#f3f6fb;
      color:#0f172a;
    }
    .wrap{max-width:720px;margin:0 auto;min-height:100vh;padding:12px}
    .card{
      background:#fff;
      border-radius:16px;
      padding:10px;
      box-shadow:0 8px 22px rgba(0,0,0,.08);
    }
    .row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:10px}
    .pill{
      padding:6px 10px;border-radius:999px;
      background:#eff6ff;color:#1d4ed8;font-weight:800;font-size:12px
    }
    h1{
      font-size:20px;
      margin:6px 0 10px 0;
      text-transform:capitalize;
      line-height:1.25;
    }
    .meta{
      font-size:15px;
      opacity:.95;
      margin-bottom:12px;
    }
    .sec{margin-top:14px}
    .sec h2{
      font-size:15px;
      margin-bottom:8px;
    }
    #summary{
      font-size:14px;
      line-height:1.55;
      white-space:pre-wrap;
      background:#f8fafc;
      border:1px solid #e5e7eb;
      border-radius:10px;
      padding:5px 5px;
    }
    .imgGrid{
      display:grid;
      grid-template-columns:repeat(3,1fr);
      gap:8px;
    }
    .imgGrid img{
      width:100%;
      height:92px;
      border-radius:12px;
      object-fit:cover;
      border:1px solid #e5e7eb;
      cursor:pointer;
    }
    .attList{display:flex;flex-direction:column;gap:10px}
    .att{
      display:flex;align-items:center;gap:10px;
      padding:10px;border-radius:14px;border:1px solid #e5e7eb;
      background:#fff;
    }
    .att .name{
      font-weight:800;
      font-size:14px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
      max-width:55vw;
    }
    .att a{
      margin-left:auto;
      background:#1d4ed8;color:#fff;
      padding:9px 12px;border-radius:12px;
      font-size:13px;text-decoration:none;font-weight:900
    }

    /* Fullscreen image viewer */
    .viewer{
      position:fixed; inset:0; z-index:99999;
      background:rgba(0,0,0,.85);
      display:none;
      place-items:center;
      padding:12px;
    }
    .viewer img{
      max-width:100%;
      max-height:88vh;
      border-radius:14px;
      box-shadow:0 18px 55px rgba(0,0,0,.35);
    }
    .viewerClose{
      position:fixed; top:14px; right:14px;
      background:#fff;
      border:0;
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      cursor:pointer;
    }

    .empty{
      opacity:.65;
      font-size:13px;
      padding:6px 0;
    }

    .ad-placeholder{
      border: 1px dashed #cbd5e1;
      border-radius: 14px;
      padding: 14px;
      background: #f8fafc;
    }
    .ad-badge{
      display:inline-block;
      padding:4px 8px;
      border-radius:999px;
      font-weight:900;
      font-size:12px;
      background:#111827;
      color:#fff;
      margin-bottom:8px;
    }
    .ad-title{font-weight:900;font-size:14px;margin-bottom:4px;}
    .ad-desc{opacity:.75;font-size:13px;line-height:1.35;}

    /* ===================================================
       ✅ Loader overlay + hide content initially
       =================================================== */
    #pageLoader{
      position:fixed;
      inset:0;
      z-index:999999;
      background:#f3f6fb;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      gap:10px;
    }
    .loaderSpin{
      width:42px;
      height:42px;
      border:4px solid #cbd5e1;
      border-top-color:#1d4ed8;
      border-radius:50%;
      animation:spin 0.9s linear infinite;
    }
    @keyframes spin{
      from{transform:rotate(0deg)}
      to{transform:rotate(360deg)}
    }
    #pageContent{ display:none; }
  </style>
</head>

<body>

  <!-- ✅ Loader -->
  <div id="pageLoader">
    <div class="loaderSpin"></div>
    <div style="font-weight:900;font-family:system-ui;">Loading property...</div>
    <div style="opacity:.7;font-size:13px;">Please wait</div>
  </div>

  <!-- ✅ Content (hidden until data is ready) -->
  <div id="pageContent">
    <div class="wrap">
      <main class="card">
        <div class="row">
          <div class="pill" id="typePill" style="display:none;"></div>
          <div class="pill" id="catPill" style="display:none;"></div>
        </div>

        <h1 id="title"></h1>

        <div class="meta">
          <div><strong>Area:</strong> <span id="area"></span></div>
		  
			<div id="sharedByRow" style="display:none;margin-top:6px;">
			  <strong>Shared By:</strong>
			  <span id="sharedBy" style="display:inline-flex;gap:6px;align-items:center;flex-wrap:wrap;"></span>
			</div>

        </div>

        <section class="sec">
          <h2>Summary:</h2>
          <div id="summary"></div>
        </section>

        <section class="sec" id="imgSec">
          <h2>Images:</h2>
          <div class="imgGrid" id="imgGrid"></div>
          <div class="empty" id="imgEmpty" style="display:none;">No images.</div>
        </section>

        <section class="sec" id="attSec">
          <h2>Files:</h2>
          <div class="attList" id="attList"></div>
          <div class="empty" id="attEmpty" style="display:none;">No files.</div>
        </section>
      </main>

      <!-- ✅ Expired UI (hidden by default) -->
      <section class="sec" id="expiredSec" style="display:none;">
        <div class="card" style="padding:14px;border-radius:16px;">
          <div style="font-weight:900;font-size:16px;margin-bottom:8px;">
            This shared link is expired.
          </div>

          <div id="expiredHint" style="opacity:.85;font-size:14px;line-height:1.45;">
            To get details about the property you should contact:
          </div>

          <div id="expiredContact" style="margin-top:10px;font-weight:900;font-size:15px;"></div>
          <div id="expiredContact2" style="margin-top:6px;opacity:.85;font-size:14px;"></div>
        </div>
      </section>

      <!-- ✅ Ad section BELOW the card (not inside it) -->
      <section class="sec" id="adSec">
        <div class="ad-placeholder">
          <div class="ad-badge">Ad</div>
          <div class="ad-title">Test Banner</div>
          <div class="ad-desc">This is a placeholder for your web ad banner.</div>
        </div>
      </section>
    </div>
  </div>

  <!-- Fullscreen image viewer -->
  <div class="viewer" id="viewer">
    <button class="viewerClose" id="viewerClose">✕</button>
    <img id="viewerImg" src="" alt="preview"/>
  </div>

<script>
  function qs(k){ return new URLSearchParams(location.search).get(k); }

  function escapeHtml(s){
    return String(s||'')
      .replace(/&/g,"&amp;")
      .replace(/</g,"&lt;")
      .replace(/>/g,"&gt;")
      .replace(/"/g,"&quot;")
      .replace(/'/g,"&#039;");
  }

  function summaryToBullets(summary) {
    let items = [];

    if (Array.isArray(summary)) {
      items = summary.map(s => String(s));
    } else if (typeof summary === 'string') {
      items = summary.split(/\r?\n/);
    } else if (summary && typeof summary === 'object') {
      items = Object.values(summary).map(v => String(v));
    }

    // cleanup lines
    items = items
      .map(s => String(s || '')
        .replace(/\u00A0/g, ' ')
        .replace(/\t/g, ' ')
        .trim()
      )
      .filter(Boolean)
      // ✅ remove bullet markers if already present
      .map(s => s.replace(/^[\s•\-\*\u2022]+/, '').trim());

    if (!items.length) return '';

    return (
      `<ul style="margin:0; padding-left:20px; list-style-type:disc;">` +
      items.map(line => `<li style="margin:0 0 3px 0;">${escapeHtml(line)}</li>`).join('') +
      `</ul>`
    );
  }

  function safeText(v){ return String(v||'').trim(); }

  function showContent(){
    const ld = document.getElementById('pageLoader');
    const ct = document.getElementById('pageContent');
    if (ld) ld.style.display = "none";
    if (ct) ct.style.display = "block";
  }

  // ✅ Register Service Worker (Cache Supabase assets)
  (function registerSW(){
    try{
      if (!('serviceWorker' in navigator)) return;
      navigator.serviceWorker.register('./sw.js')
        .catch(err => console.warn('SW register failed', err));
    }catch(e){}
  })();

  // ===================================================
  // ✅ Cache shared_by/contact so expired link can show fallback
  // ===================================================
  function cacheShareContact(sid, payload){
    try{
      const obj = {
        shared_by: safeText(payload?.shared_by),
        shared_contact: safeText(payload?.shared_contact),
        cached_at: Date.now()
      };
      localStorage.setItem(`share_contact_${sid}`, JSON.stringify(obj));
    }catch(e){}
  }

  function getCachedShareContact(sid){
    try{
      const raw = localStorage.getItem(`share_contact_${sid}`);
      if (!raw) return null;
      return JSON.parse(raw);
    }catch(e){ return null; }
  }

async function fetchFallbackContactFromServer(sid){
  try{
    const contactFile = `share_contact_${encodeURIComponent(sid)}.json`;
    const contactUrl =
      `https://mxuknvleveqqybhbhwnv.supabase.co/storage/v1/object/public/shares/${contactFile}`;

    const r = await fetch(contactUrl);
    if (!r.ok) return null;

    const payload = await r.json();
    if (!payload) return null;

    return payload;
  }catch(e){
    return null;
  }
}


  async function showExpiredUI(sid){
    // hide property sections
    const title = document.getElementById('title');
	const metaBlock = document.querySelector('.meta');
    const area = document.getElementById('area');
    const summary = document.getElementById('summary');
	const summarySection = summary ? summary.closest('section') : null;
    const imgSec = document.getElementById('imgSec');
    const attSec = document.getElementById('attSec');
    const sharedByRow = document.getElementById('sharedByRow');

    if (title) title.textContent = '';
    if (area) area.textContent = '';
    if (summary) summary.innerHTML = '';
    if (imgSec) imgSec.style.display = 'none';
    if (attSec) attSec.style.display = 'none';
    if (sharedByRow) sharedByRow.style.display = 'none';

    // show expired section
    const expiredSec = document.getElementById('expiredSec');
    const expiredContact = document.getElementById('expiredContact');
    const expiredContact2 = document.getElementById('expiredContact2');

    if (expiredSec) expiredSec.style.display = 'block';

	let cached = getCachedShareContact(sid);

	// ✅ If no local cache, try fetch fallback contact json from server
	if (!cached) {
	  const serverFallback = await fetchFallbackContactFromServer(sid);
	  if (serverFallback) {
		cacheShareContact(sid, serverFallback);
		cached = getCachedShareContact(sid);
	  }
	}

	const name = safeText(cached?.shared_by);
	const phone = safeText(cached?.shared_contact);


    if (expiredContact) {
      expiredContact.textContent = (name || phone) ? (name || 'Shared By') : 'Contact information not available.';
    }
	if (expiredContact2) {
	  if (phone) {
		expiredContact2.innerHTML = `
		  <span>${escapeHtml(phone)}</span>
		  <a
			href="tel:${escapeHtml(String(phone).trim())}"
			title="Call"
			style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;
				   margin-left:10px;"
		  >
			<i class="fa fa-phone" style="color:green;font-size:18px;"></i>
		  </a>
		`;
	  } else {
		expiredContact2.textContent = '';
	  }
	}


    // ✅ show page even in expired mode so Ad remains visible
    showContent();
  }

  (function init(){
    const sid = String(qs('sid') || '').trim();

    if (!sid){
      document.body.innerHTML = "<div style='padding:18px;font-weight:900;font-family:system-ui'>Invalid share link.</div>";
      return;
    }

    (async function(){
      try{
        const jsonFile = `share_${encodeURIComponent(sid)}.json`;

        const jsonUrl =
          `https://mxuknvleveqqybhbhwnv.supabase.co/storage/v1/object/public/shares/${encodeURIComponent(jsonFile)}`;

        // ✅ DO NOT use no-store, allow SW + browser caching
        const res = await fetch(jsonUrl);
        if (!res.ok) throw new Error("Share JSON not found");

        const payload = await res.json();
        if (!payload) throw new Error("Invalid JSON payload");

        // ✅ Cache shared_by/contact for fallback later
        cacheShareContact(sid, payload);

        // ✅ Render UI
        document.getElementById('title').textContent = safeText(payload.title);
        document.getElementById('area').textContent  = safeText(payload.area);
        document.getElementById('summary').innerHTML = summaryToBullets(payload.summary);

		// Shared By
		const sb = safeText(payload.shared_by);
		const sc = safeText(payload.shared_contact);
		const sharedByRow = document.getElementById('sharedByRow');
		const sharedBy = document.getElementById('sharedBy');

		if ((sb || sc) && sharedByRow && sharedBy) {
		  sharedByRow.style.display = "block";

		  // ✅ Reuse Favorites logic: show phone icon only if contact exists
		  sharedBy.innerHTML = `
			<span style="font-weight:500;">${escapeHtml(sb || 'N/A')}</span>
			${sc ? `<span style="opacity:0.7;"> - </span><span>${escapeHtml(sc)}</span>` : ''}
			${
			  sc
				? `<a
					 href="tel:${escapeHtml(String(sc).trim())}"
					 title="Call Publisher"
					 style="text-decoration:none;display:inline-flex;align-items:center;justify-content:center;
							margin-left:10px;"
				   >
					 <i class="fa fa-phone" style="color:green;font-size:18px;"></i>
				   </a>`
				: ``
			}
		  `;
		}


        // Pills
        const type = safeText(payload.type);
        const cat  = safeText(payload.category);

        const typePill = document.getElementById('typePill');
        const catPill  = document.getElementById('catPill');

        if (type) { typePill.textContent = type; typePill.style.display = "inline-flex"; }
        if (cat)  { catPill.textContent  = cat;  catPill.style.display  = "inline-flex"; }

        // Images
        const imgs = Array.isArray(payload.images) ? payload.images : [];
        const imgSec  = document.getElementById('imgSec');
        const imgGrid = document.getElementById('imgGrid');

        if (!imgs.length){
          if (imgSec) imgSec.style.display = "none";
        } else {
          if (imgSec) imgSec.style.display = "block";
          imgGrid.innerHTML = imgs.map(src =>
            `<img src="${escapeHtml(src)}" data-src="${escapeHtml(src)}" alt="image">`
          ).join('');
        }

        // Attachments
        const atts = Array.isArray(payload.attachments) ? payload.attachments : [];
        const attSec  = document.getElementById('attSec');
        const attList = document.getElementById('attList');

        if (!atts.length){
          if (attSec) attSec.style.display = "none";
        } else {
          if (attSec) attSec.style.display = "block";
          attList.innerHTML = atts.map((a, idx) => {
            const name = escapeHtml(a?.name || ("Attachment " + (idx+1)));
            const src  = escapeHtml(a?.src || "");
            return `
              <div class="att">
                <div class="name">${name}</div>
                <a href="${src}" target="_blank" rel="noopener">Open</a>
              </div>
            `;
          }).join('');
        }

        // Fullscreen image viewer
        const viewer = document.getElementById('viewer');
        const viewerImg = document.getElementById('viewerImg');
        const viewerClose = document.getElementById('viewerClose');

        let viewerOpen = false;

        imgGrid.addEventListener('click', (e) => {
          const t = e.target;
          if (!t || t.tagName !== "IMG") return;

          const src = t.getAttribute("data-src") || t.getAttribute("src");
          if (!src) return;

          viewerImg.src = src;
          viewer.style.display = "grid";

          // ✅ Push a history entry so Back button closes viewer first
          if (!viewerOpen) {
            viewerOpen = true;
            history.pushState({ viewer: true }, "");
          }
        });

        function closeViewer(fromPopstate = false){
          viewer.style.display = "none";
          viewerImg.src = "";

          // ✅ If user closed by ✕ button, remove viewer history state
          if (viewerOpen && !fromPopstate) {
            viewerOpen = false;
            history.back();
          } else {
            viewerOpen = false;
          }
        }

        window.addEventListener('popstate', (event) => {
          if (viewerOpen) {
            // ✅ Back button should close viewer, not exit page
            closeViewer(true);
          }
        });

        viewerClose.addEventListener('click', closeViewer);
        viewer.addEventListener('click', (e) => {
          if (e.target === viewer) closeViewer();
        });

        // ✅ Show page only AFTER everything is ready
        showContent();

      }catch(e){
        const ld = document.getElementById('pageLoader');
        if (ld) ld.style.display = "none";

        // ✅ show expired UI (keeps Ad section visible)
        await showExpiredUI(sid);

      }
    })();
  })();
</script>

</body>
</html>
